# 🏪 玉子市场 Tamako Market

[![GitHub release](https://img.shields.io/github/v/release/yuzi83/st-tamako-market)](https://github.com/yuzi83/st-tamako-market/releases)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

SillyTavern 可爱风格悬浮窗扩展，用于捕获和管理特定标签内容。

## ✨ 功能特色

- 🌙 **夜间模式 + 自定义主题** - 默认深色护眼风格，支持完全自定义
- 🎨 **主题编辑器** - 自由调整颜色、透明度、字体
- 🔘 **按钮自定义** - 形状（长条/圆形）、大小、自定义图片
- 🔍 **智能搜索** - 支持 AM 编号和关键词搜索
- 🐔 **德拉小助手** - 可爱的状态提示语
- 📦 **库存管理** - 历史记录查看与管理
- 🧹 **选择性删除** - 批量清理不需要的记录
- 🏷️ **自定义标签** - 灵活配置捕获规则
- 🖱️ **自由拖拽** - 可调整窗口和按钮位置，窗口可缩放
- 📱 **移动端支持** - 完美支持手机端触摸操作
- 🎭 **多模板美化器** - 支持保存多个 HTML 模板并自由切换
- 🔄 **自动同步** - 消息删除时自动更新捕获内容
- 🎯 **吸管取色** - PC 端支持从屏幕任意位置吸取颜色（支持原生 EyeDropper API）

## 📥 安装方法

### 方法一：URL 安装（推荐）

1. 打开 SillyTavern
2. 进入 **扩展** → **安装扩展**
3. 输入仓库地址：`https://github.com/yuzi83/st-tamako-market`
4. 点击安装，然后重启 SillyTavern

### 方法二：手动安装

1. [下载最新版本](https://github.com/yuzi83/st-tamako-market/releases)
2. 解压到 SillyTavern 的 `data/default-user/extensions/` 目录
3. 重启 SillyTavern

## 🎯 使用方法

### 基本操作

1. 点击 **🏪 玉子市场** 按钮打开窗口
2. 扩展会自动捕获包含指定标签的用户消息
3. 在 **📦 库存** 中查看历史记录

### 窗口按钮说明

| 按钮 | 功能 |
|:----:|------|
| ➖ | 最小化窗口 |
| 🔍 | 扫描历史消息 |
| 🧹 | 进入删除模式 |
| 🎨 | 切换主题 |
| ✏️ | 打开主题编辑器 |
| ✖ | 关闭窗口 |

### 拖拽功能

- **窗口拖拽**：拖拽窗口标题栏可移动窗口位置
- **按钮拖拽**：拖拽"玉子市场"按钮可移动按钮位置
- **窗口缩放**：拖拽窗口右边/下边/右下角可调整大小
- **位置记忆**：所有位置会自动保存

### 默认捕获标签

- `recall`
- `scene_direction`

可在设置中自定义添加其他标签。

## 🎭 美化器功能

多模板美化器，支持保存多个 HTML 模板并自由切换。

### 使用方法

1. 在扩展设置中找到 **🎨 今日特选美化器**
2. 勾选 **启用美化器**
3. 点击上传区域，选择你的 HTML 模板文件
4. 模板会自动保存到列表中并激活
5. 可以继续上传更多模板（最多 10 个）
6. 使用下拉框或列表中的"使用"按钮切换模板

### 模板管理

| 操作 | 说明 |
|------|------|
| 使用 | 切换到该模板 |
| ✏️ | 重命名模板 |
| 🗑️ | 删除模板 |
| 测试当前 | 预览当前选中模板的效果 |
| 清空全部 | 删除所有已保存的模板 |

### 支持的文件格式

- `.html` - 标准 HTML 文件
- `.htm` - HTML 文件
- `.json` - 包含 `replaceString` 字段的 JSON 文件（兼容正则脚本格式）
- `.txt` - 纯文本 HTML 内容

### 模板开发

模板使用 `$1` 占位符接收原始用户消息。模板内可使用以下全局变量和函数：

- `window.getSTChat()` - 获取聊天数据（推荐）
- `window.getContext()` - 获取 SillyTavern 上下文

**兼容性说明**：美化器完全兼容现有的正则脚本模板（如回响），模板自带的数据获取函数会被优先使用。

## 🎨 主题编辑器

支持完全自定义主题样式。

### 可调整选项

- **颜色设置** - 主色、辅色、表面色、次要表面色、文字色、次要文字色共 6 种颜色
- **透明度** - 50%-100% 窗口透明度
- **字体选择** - 8 种字体可选
- **按钮形状** - 长条形 / 圆形
- **按钮大小** - 60%-150% 自由缩放
- **按钮图片** - 支持上传自定义图片替换按钮外观

### 字体选项

| 字体 | 描述 |
|------|------|
| 📱 系统默认 | Segoe UI / 微软雅黑 |
| 🎀 可爱圆润 | Comic Sans MS |
| 📜 优雅衬线 | Georgia / Noto Serif |
| 💻 等宽代码 | Consolas |
| ⭕ 圆体 | 苹方圆体 |
| 📖 宋体 | Noto Serif SC / 宋体 |
| 🔲 黑体 | Noto Sans SC / 黑体 |
| 🖌️ 楷体 | 楷体 |

### 吸管取色（仅 PC 端）

点击颜色输入框旁的吸管按钮，可从屏幕任意位置吸取颜色。支持原生 EyeDropper API（Chrome 95+）或 CSS 计算样式备用方案。

## ⚙️ 设置选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| 启用扩展 | 开启/关闭扩展功能 | ✅ 开启 |
| 自动捕获 | 自动捕获新消息 | ✅ 开启 |
| 捕获标签 | 要捕获的 XML 标签名 | recall, scene_direction |
| 扫描消息数 | 每次扫描的最大消息数 | 50 |
| 最大存储数 | 库存最大保存记录数 | 50 |
| 启用美化器 | 使用自定义模板显示 | ❌ 关闭 |

## 🐔 德拉小助手

德拉会在不同状态下显示可爱的提示语：

- 💤 **空闲时**：「空空如也~」
- ✨ **新货到**：「发现新内容」
- 🔍 **搜索中**：「正在搜寻...」
- 📦 **清理后**：「已清理」
- 🎨 **换主题**：「主题已切换」
- 🎭 **换模板**：「切换成功」
- 🔘 **按钮更新**：「按钮更新了」

## 🔧 兼容性

- SillyTavern 1.10.0 及以上版本
- 支持所有现代浏览器（Chrome、Firefox、Edge 等）
- 📱 支持手机端（Android / iOS）
- 🎭 兼容现有正则脚本模板（如回响 V6）

## 📝 更新日志

### v2.8.3

- 🔘 **新增按钮自定义** - 支持长条形/圆形切换、大小缩放（60%-150%）、自定义图片
- 🎨 按钮实时预览 - 编辑器内直接预览按钮外观
- 🖼️ 支持上传 jpg/png/gif 图片替换按钮
- ⚡ 主题系统简化 - 默认使用夜间模式，移除多余预设
- 🐛 修复各类样式和交互问题

### v2.6.0

- 🎭 **新增多模板切换功能** - 可保存最多 10 个美化模板并自由切换
- 📦 模板管理 - 支持重命名、删除模板
- 🔄 自动迁移 - 旧版单模板设置自动迁移到新结构
- 🏗️ 代码模块化重构 - 提升可维护性和性能
- ✨ 新增模板切换提示语

### v2.5.3

- 🗑️ 移除背景渐变设置（简化编辑器）
- ✨ 新增更多字体选项
- ✨ 新增字体实时预览功能

### v2.5.0

- 🎨 **新增主题编辑器**
- 🎯 **新增吸管取色**
- 🎨 新增调色盘组件
- 📦 自定义主题自动保存

### v2.4.0

- 🎭 **新增美化器功能**
- 🎨 CSS 重构：使用变量驱动主题系统

### v2.0.0

- ✨ 新增主题系统
- ✨ 新增智能搜索功能
- ✨ 新增德拉小助手提示

## 📁 项目结构

    TamakoMarket/
    ├── index.js              # 入口文件
    ├── style.css             # 样式表
    ├── manifest.json         # 扩展配置
    ├── README.md             # 说明文档
    └── modules/              # 模块目录
        ├── constants.js      # 常量定义
        ├── state.js          # 状态管理
        ├── utils.js          # 工具函数
        ├── beautifier.js     # 美化器系统
        ├── capture.js        # 消息捕获
        ├── theme-editor.js   # 主题编辑器
        ├── settings-panel.js # 设置面板
        └── window.js         # 窗口管理

## 📄 许可证

[MIT License](LICENSE)

---

德拉：欢迎光临玉子市场！🐔✨
