# 🏪 玉子市场 Tamako Market

[![GitHub release](https://img.shields.io/github/v/release/yuzi83/st-tamako-market)](https://github.com/yuzi83/st-tamako-market/releases)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

SillyTavern 可爱风格悬浮窗扩展，用于捕获和管理特定标签内容。

## ✨ 功能特色

- 🎨 **四种可爱主题** - 玉子市场 / 海边小店 / 向日葵田 / 夜间模式
- 🔍 **智能搜索** - 支持 AM 编号和关键词搜索
- 🐔 **德拉小助手** - 可爱的状态提示语
- 📦 **库存管理** - 历史记录查看与管理
- 🧹 **选择性删除** - 批量清理不需要的记录
- 🏷️ **自定义标签** - 灵活配置捕获规则
- 🖱️ **自由拖拽** - 可调整窗口位置和大小
- 📱 **移动端支持** - 完美支持手机端触摸操作
- 🎭 **自定义美化器** - 支持上传 HTML 模板自定义显示样式
- 🔄 **自动同步** - 消息删除时自动更新捕获内容

## 📥 安装方法

### 方法一：URL 安装（推荐）

1. 打开 SillyTavern
2. 进入 **扩展** → **安装扩展**
3. 输入仓库地址：`https://github.com/yuzi83/st-tamako-market`
4. 点击安装，然后重启 SillyTavern

### 方法二：手动安装

1. [下载最新版本](https://github.com/yuzi83/st-tamako-market/releases)
2. 解压到 SillyTavern-1.15.0\public\scripts\extensions\third-party
3. 重启 SillyTavern

## 🎯 使用方法

### 基本操作

1. 点击 **🏪 玉子市场** 按钮打开窗口
2. 扩展会自动捕获包含指定标签的用户消息
3. 在 **📦 库存** 中查看历史记录

### 窗口按钮说明

| 按钮 | 功能 |
|:----:|------|
| ➖ | 最小化窗口 |
| 🔍 | 扫描历史消息 |
| 🧹 | 进入删除模式 |
| 🎨 | 切换主题 |
| ✖ | 关闭窗口 |

### 拖拽功能

- **窗口拖拽**：拖拽窗口标题栏可移动窗口位置
- **按钮拖拽**：拖拽"玉子市场"按钮可移动按钮位置
- **窗口缩放**：拖拽窗口右边/下边/右下角可调整大小
- **位置记忆**：所有位置会自动保存

### 默认捕获标签

- `recall`
- `scene_direction`

可在设置中自定义添加其他标签。

## 🎭 美化器功能

v2.4.0 新增的强大功能，支持自定义 HTML 模板来美化"今日特选"的显示效果。

### 使用方法

1. 在扩展设置中找到 **今日特选美化器**
2. 勾选 **启用美化器**
3. 点击上传区域，选择你的 HTML 模板文件
4. 点击 **保存** 应用模板
5. 点击 **测试** 预览效果

### 支持的文件格式

- `.html` - 标准 HTML 文件
- `.htm` - HTML 文件
- `.json` - 包含 `replaceString` 字段的 JSON 文件（兼容正则脚本格式）
- `.txt` - 纯文本 HTML 内容

### 模板开发

模板使用 `$1` 占位符接收原始用户消息。模板内可使用以下全局变量和函数：

- `window.getSTChat()` - 获取聊天数据（推荐）
- `window.getContext()` - 获取 SillyTavern 上下文
- `window.extractTagFromChat(tagName)` - 从聊天中提取指定标签
- `window.extractFileFromContent()` - 提取 content/file 内容

**兼容性说明**：美化器完全兼容现有的正则脚本模板（如回响），模板自带的数据获取函数会被优先使用。

## 🎨 主题预览

| 主题 | 描述 |
|------|------|
| 🌸 玉子市场 | 粉色可爱风（默认） |
| 🌊 海边小店 | 蓝色清新风 |
| 🌻 向日葵田 | 黄色活力风 |
| 🌙 夜间模式 | 深色护眼风 |

## ⚙️ 设置选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| 启用扩展 | 开启/关闭扩展功能 | ✅ 开启 |
| 自动捕获 | 自动捕获新消息 | ✅ 开启 |
| 捕获标签 | 要捕获的 XML 标签名 | recall, scene_direction |
| 扫描消息数 | 每次扫描的最大消息数 | 50 |
| 最大存储数 | 库存最大保存记录数 | 50 |
| 启用美化器 | 使用自定义模板显示 | ❌ 关闭 |

## 🐔 德拉小助手

德拉会在不同状态下显示可爱的提示语：

- 💤 **空闲时**：「德拉在打瞌睡...」
- ✨ **新货到**：「德拉发现了新货！」
- 🔍 **搜索中**：「德拉正在努力搜寻...」
- 📦 **清理后**：「德拉帮你打包好了~」

## 🔧 兼容性

- SillyTavern 1.10.0 及以上版本
- 支持所有现代浏览器（Chrome、Firefox、Edge 等）
- 📱 支持手机端（Android / iOS）
- 🎭 兼容现有正则脚本模板（如回响 V6）

## 📝 更新日志

### v2.4.7

- 🐛 修复反引号包裹的标签名被错误匹配的问题
- 🐛 修复说明文字中的 `` `<prologue>` `` 等被误认为真实标签
- ⚡ 使用负向后行断言优化标签提取正则表达式

### v2.4.6

- 🐛 修复美化器与回响等正则脚本模板的兼容性问题
- 🐛 修复模板自带函数被错误覆盖的问题
- ⚡ 优化数据传递机制，使用 window.name 替代 Base64 编码
- 🔧 美化器现在完全尊重模板自带的数据获取逻辑

### v2.4.5

- 🐛 修复美化器注入脚本被特殊字符破坏导致代码泄露的问题
- ⚡ 使用 Base64 编码传输数据避免特殊字符问题
- ⚡ 使用 Blob URL 替代 srcdoc 提高稳定性

### v2.4.4

- 🐛 修复启动时按钮主题颜色透明的问题
- 🐛 修复美化器渲染时会短暂显示未美化内容的问题
- ✨ 美化器加载时显示可爱的等待动画
- ⚡ 优化主题初始化逻辑

### v2.4.3

- 🐛 修复美化器渲染时机问题
- ✨ 新增美化器加载状态显示
- ⚡ 优化模板解析和 HTML 结构包装

### v2.4.2

- ✨ 新增消息删除自动检测，删除用户输入后窗口自动更新
- ⚡ 优化拖拽/缩放窗口时隐藏美化器 iframe，大幅减少卡顿
- 📱 移动端优化：阻止长按触发右键菜单

### v2.4.0

- 🎭 **新增美化器功能** - 支持上传自定义 HTML 模板
- 🎨 CSS 重构：使用变量驱动主题系统，代码减少约 30%
- 🌙 优化夜间模式：统一使用 CSS 变量，样式更一致
- 📜 简化滚动条：移除 RTL 技巧，回归标准右侧滚动条
- 🔧 美化器支持多种文件格式（HTML/JSON/TXT）
- 📊 模板内可访问完整聊天数据和辅助函数

### v2.1.5

- 🐛 修复关键词匹配问题，支持更多变体格式

### v2.1.4

- 🐛 修复内容区文字不自动换行的问题
- 🐛 修复滚动条被缩放手柄遮挡的问题
- 💄 优化内容显示区域样式

### v2.1.2

- ✨ 新增手机端触摸拖拽窗口支持
- ✨ 新增手机端触摸缩放窗口支持
- ✨ 新增"玉子市场"按钮可拖拽功能
- ✨ 按钮和窗口位置自动保存
- ✨ 新增"重置按钮"功能
- 🐛 修复窗口层级问题
- 💄 移动端UI适配优化

### v2.0.0

- ✨ 新增四种可爱主题
- ✨ 新增智能搜索功能
- ✨ 新增德拉小助手提示
- ✨ 新增扫描数量限制设置
- 🐛 修复自动捕获偶尔失效的问题
- 💄 优化 UI 设计和动画效果

## 📄 许可证

[MIT License](LICENSE)

---

<p align="center">
<i>德拉：欢迎光临玉子市场！🐔✨</i>
</p>
